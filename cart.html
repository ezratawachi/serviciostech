<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Carrito de servicios | Canal Datos</title>

    <meta
      name="description"
      content="Revisa los servicios seleccionados, ajusta cantidades y env√≠a tu pedido para que el equipo de Canal Datos te contacte."
    />
    <meta name="author" content="Canal Datos" />
    <meta name="theme-color" content="#2563eb" />

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üõí</text></svg>" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <script>
      window.tailwind = window.tailwind || {};
      window.tailwind.config = {
        theme: {
          extend: {
            screens: { xs: "475px" },
            colors: {
              brand: {
                50: "#eef7ff",
                100: "#d8ecff",
                200: "#b9dbff",
                300: "#8bc4ff",
                400: "#57a5ff",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
                800: "#1e40af",
                900: "#1e3a8a",
              },
            },
            boxShadow: {
              card: "0 12px 30px rgba(15, 23, 42, 0.08)",
            },
            fontFamily: {
              sans: [
                "Inter",
                "ui-sans-serif",
                "system-ui",
                "-apple-system",
                "Segoe UI",
                "Roboto",
                "Helvetica",
                "Arial",
                "Apple Color Emoji",
                "Segoe UI Emoji",
              ],
            },
            borderRadius: {
              xl: "1rem",
              "2xl": "1.25rem",
            },
          },
        },
      };
    </script>
    <script
      defer
      src="https://cdn.tailwindcss.com"
    ></script>

    <style>
      .skip-link {
        position: absolute;
        left: -999px;
        top: 1rem;
        padding: 0.5rem 1rem;
        background: #2563eb;
        color: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.28);
        transition: left 0.2s ease;
        z-index: 100;
      }
      .skip-link:focus {
        left: 1rem;
      }
      .toast-layer {
        position: fixed;
        left: 50%;
        bottom: 1.5rem;
        transform: translate(-50%, 0);
        z-index: 70;
        border-radius: 0.75rem;
        background: #2563eb;
        color: #fff;
        padding: 0.6rem 1.1rem;
        font-size: 0.875rem;
        font-weight: 600;
        box-shadow: 0 12px 30px rgba(37, 99, 235, 0.35);
        transition: opacity 0.25s ease, transform 0.25s ease;
      }
      body.is-loading {
        opacity: 0;
      }
      body.is-ready {
        opacity: 1;
        transition: opacity 0.25s ease;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800 font-sans antialiased is-loading">
    <a href="#contenido-principal" class="skip-link">Saltar al contenido</a>

    <header class="sticky top-0 z-40 border-b border-slate-200 bg-white/80 backdrop-blur">
      <nav class="mx-auto w-full max-w-7xl px-4 sm:px-6 lg:px-8" aria-label="Principal">
        <div class="flex h-16 items-center justify-between gap-4">
          <a href="index.html" class="text-lg font-extrabold tracking-tight text-slate-900">Canal Datos</a>
          <div class="hidden items-center gap-2 text-sm font-semibold text-slate-600 md:flex">
            <a href="index.html#galeria" class="rounded-lg px-3 py-2 hover:bg-slate-100">Servicios</a>
            <a href="index.html#detalles" class="rounded-lg px-3 py-2 hover:bg-slate-100">Detalles</a>
            <a href="index.html#contacto" class="rounded-lg px-3 py-2 hover:bg-slate-100">Contacto</a>
            <a
              href="cart.html"
              aria-current="page"
              class="relative inline-flex items-center gap-2 rounded-xl border border-slate-200 px-3 py-2 text-slate-700 transition hover:bg-slate-50"
            >
              Carrito
              <span
                data-cart-count
                class="hidden inline-flex h-5 min-w-[1.25rem] items-center justify-center rounded-full bg-[#2563eb] px-1 text-[10px] font-extrabold leading-none text-white"
                aria-live="polite"
              ></span>
            </a>
          </div>
          <button
            type="button"
            id="mobile-menu-button"
            class="inline-flex h-11 w-11 items-center justify-center rounded-xl border border-slate-200 text-slate-700 transition hover:bg-slate-50 md:hidden"
            aria-controls="mobile-menu"
            aria-expanded="false"
          >
            <span class="sr-only">Abrir men√∫</span>
            <svg
              data-menu-icon="open"
              class="h-6 w-6"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            <svg
              data-menu-icon="close"
              class="hidden h-6 w-6"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="m6 6 12 12M6 18 18 6" />
            </svg>
          </button>
        </div>
      </nav>
      <div id="mobile-menu" class="hidden border-t border-slate-200 bg-white/95 md:hidden">
        <div class="mx-auto flex max-w-7xl flex-col gap-2 px-4 py-4 text-sm font-semibold text-slate-700">
          <a href="index.html#galeria" class="rounded-lg px-3 py-2 hover:bg-slate-100" data-mobile-link>Servicios</a>
          <a href="index.html#detalles" class="rounded-lg px-3 py-2 hover:bg-slate-100" data-mobile-link>Detalles</a>
          <a href="index.html#contacto" class="rounded-lg px-3 py-2 hover:bg-slate-100" data-mobile-link>Contacto</a>
          <a
            href="cart.html"
            aria-current="page"
            class="flex items-center justify-between rounded-lg px-3 py-2 hover:bg-slate-100"
            data-mobile-link
          >
            Carrito
            <span
              data-cart-count
              class="hidden inline-flex h-5 min-w-[1.25rem] items-center justify-center rounded-full bg-[#2563eb] px-1 text-[10px] font-extrabold leading-none text-white"
            ></span>
          </a>
        </div>
      </div>
    </header>

    <main id="contenido-principal" class="mx-auto w-full max-w-5xl px-4 pb-14 pt-10 sm:px-6 lg:px-8">
      <section>
        <header class="text-center">
          <p class="text-xs font-semibold uppercase tracking-wide text-brand-600">Canal Datos</p>
          <h1 class="mt-2 text-3xl font-extrabold tracking-tight text-slate-900 sm:text-4xl">Carrito de servicios</h1>
          <p class="mx-auto mt-3 max-w-2xl text-sm sm:text-base text-slate-600">
            Revisa los servicios seleccionados, ajusta cantidades y env√≠a tus datos para que coordinemos el siguiente paso.
          </p>
        </header>

        <div class="mt-10 grid gap-6 lg:grid-cols-[1.2fr_0.8fr]">
          <section class="space-y-4">
            <div class="rounded-2xl border border-slate-200 bg-white shadow-card">
              <div class="flex items-center justify-between border-b border-slate-200 px-5 py-4">
                <h2 class="text-base font-semibold text-slate-900">Servicios seleccionados</h2>
                <button
                  type="button"
                  id="clear-cart"
                  class="text-xs font-semibold uppercase tracking-wide text-slate-500 transition hover:text-brand-600"
                >
                  Vaciar carrito
                </button>
              </div>
              <div id="cart-items" class="divide-y divide-slate-200">
                <!-- Items renderizados por JS -->
              </div>
              <div class="flex items-center justify-between px-5 py-4">
                <span class="text-sm font-semibold text-slate-600">Total estimado</span>
                <span id="cart-total" class="text-lg font-bold text-slate-900">USD $0</span>
              </div>
            </div>
            <a
              href="index.html#galeria"
              class="inline-flex w-full items-center justify-center gap-2 rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm font-semibold text-slate-900 transition hover:bg-slate-100"
            >
              ‚Üê Seguir explorando servicios
            </a>
          </section>

          <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-card">
            <h2 class="text-base font-semibold text-slate-900">Env√≠a tu pedido</h2>
            <p class="mt-1 text-sm text-slate-600">Completa tus datos y recibir√°s confirmaci√≥n en menos de 24 horas h√°biles.</p>
            <form id="checkout-form" class="mt-6 space-y-4">
              <div>
                <label for="name" class="text-sm font-medium text-slate-700">Nombre completo</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  required
                  autocomplete="name"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-900 transition focus-visible:border-brand-500 focus-visible:bg-white focus-visible:outline-none"
                />
              </div>
              <div>
                <label for="email" class="text-sm font-medium text-slate-700">Correo electr√≥nico</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  autocomplete="email"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-900 transition focus-visible:border-brand-500 focus-visible:bg-white focus-visible:outline-none"
                />
              </div>
              <div>
                <label
                  class="flex items-start gap-3 rounded-xl border border-slate-200 bg-slate-50 px-3 py-3 text-sm font-medium text-slate-700"
                  for="whatsapp-opt-in"
                >
                  <input
                    id="whatsapp-opt-in"
                    name="whatsappOptIn"
                    type="checkbox"
                    class="mt-1 h-4 w-4 rounded border-slate-300 text-brand-600 transition focus:ring-brand-500"
                  />
                  <span>
                    ¬øQuieres que te contactemos por WhatsApp?
                    <span class="mt-1 block text-xs font-normal text-slate-500">
                      Te escribiremos al n√∫mero que nos indiques.
                    </span>
                  </span>
                </label>
              </div>
              <div id="whatsapp-field" class="hidden">
                <label for="whatsapp-number" class="text-sm font-medium text-slate-700">N√∫mero de WhatsApp</label>
                <input
                  type="tel"
                  id="whatsapp-number"
                  name="whatsappNumber"
                  autocomplete="tel"
                  inputmode="tel"
                  placeholder="Ej: +507 6000-0000"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-900 transition focus-visible:border-brand-500 focus-visible:bg-white focus-visible:outline-none"
                />
              </div>
              <div>
                <label for="company" class="text-sm font-medium text-slate-700">Empresa (opcional)</label>
                <input
                  type="text"
                  id="company"
                  name="company"
                  autocomplete="organization"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-900 transition focus-visible:border-brand-500 focus-visible:bg-white focus-visible:outline-none"
                />
              </div>
              <button
                type="submit"
                class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-[#2563eb] px-4 py-2.5 text-sm font-semibold text-white shadow-card transition hover:bg-[#1d4ed8] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#1d4ed8] disabled:cursor-not-allowed disabled:opacity-40"
              >
                Enviar pedido
              </button>
            </form>
          </section>
        </div>
      </section>
    </main>

    <footer class="border-t border-slate-200 bg-white/80">
      <div class="mx-auto w-full max-w-7xl px-4 py-6 text-center text-xs sm:text-sm text-slate-600">
        ¬© 2025 Canal Datos ¬∑ Servicios digitales para empresas en Panam√°.
      </div>
    </footer>

    <div id="toast" class="toast-layer" style="opacity: 0; pointer-events: none"></div>

    <script>
      const storageKey = "ezraServicesCart";
      const EMAIL_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbxsveSHW1PjbIKBQv4apyYQhaWWe-JnL6I1f2Kf4yOHLWFlTgzLl67Vgp8qZAOhLQHb/exec";

      const itemsContainer = document.getElementById("cart-items");
      const totalEl = document.getElementById("cart-total");
      const toastLayer = document.getElementById("toast");
      const clearBtn = document.getElementById("clear-cart");
      const mobileMenuButton = document.getElementById("mobile-menu-button");
      const mobileMenu = document.getElementById("mobile-menu");
      const whatsappCheckbox = document.getElementById("whatsapp-opt-in");
      const whatsappFieldWrapper = document.getElementById("whatsapp-field");
      const whatsappInput = document.getElementById("whatsapp-number");

      const syncWhatsappField = () => {
        if (!whatsappCheckbox || !whatsappFieldWrapper || !whatsappInput) return;
        const wantsWhatsapp = whatsappCheckbox.checked;
        whatsappFieldWrapper.classList.toggle("hidden", !wantsWhatsapp);
        whatsappInput.required = wantsWhatsapp;
        if (!wantsWhatsapp) {
          whatsappInput.value = "";
        }
      };

      if (whatsappCheckbox) {
        whatsappCheckbox.addEventListener("change", syncWhatsappField);
        syncWhatsappField();
      }

      if (mobileMenuButton && mobileMenu) {
        const mobileMenuIcons = {
          open: mobileMenuButton.querySelector('[data-menu-icon="open"]'),
          close: mobileMenuButton.querySelector('[data-menu-icon="close"]'),
        };

        const setMenuState = (open) => {
          mobileMenuButton.setAttribute("aria-expanded", String(open));
          if (open) {
            mobileMenu.classList.remove("hidden");
            if (mobileMenuIcons.open) {
              mobileMenuIcons.open.classList.add("hidden");
            }
            if (mobileMenuIcons.close) {
              mobileMenuIcons.close.classList.remove("hidden");
            }
          } else {
            mobileMenu.classList.add("hidden");
            if (mobileMenuIcons.open) {
              mobileMenuIcons.open.classList.remove("hidden");
            }
            if (mobileMenuIcons.close) {
              mobileMenuIcons.close.classList.add("hidden");
            }
          }
        };

        mobileMenuButton.addEventListener("click", () => {
          const isOpen = mobileMenuButton.getAttribute("aria-expanded") === "true";
          setMenuState(!isOpen);
        });

        document.querySelectorAll("[data-mobile-link]").forEach((link) => {
          link.addEventListener("click", () => setMenuState(false));
        });

        const desktopBreakpoint = window.matchMedia("(min-width: 768px)");
        const handleBreakpointChange = (event) => {
          if (event.matches) {
            setMenuState(false);
          }
        };

        if (typeof desktopBreakpoint.addEventListener === "function") {
          desktopBreakpoint.addEventListener("change", handleBreakpointChange);
        } else if (typeof desktopBreakpoint.addListener === "function") {
          desktopBreakpoint.addListener(handleBreakpointChange);
        }

        setMenuState(false);
      }

      const formatCurrency = (value) =>
        new Intl.NumberFormat("es-PA", {
          style: "currency",
          currency: "USD",
          minimumFractionDigits: 0,
        }).format(value);

      function getCart() {
        try {
          const raw = localStorage.getItem(storageKey);
          return raw ? JSON.parse(raw) : [];
        } catch (error) {
          console.error("No se pudo leer el carrito", error);
          return [];
        }
      }

      function setCart(items) {
        try {
          localStorage.setItem(storageKey, JSON.stringify(items));
        } catch (error) {
          console.error("No se pudo guardar el carrito", error);
        }
      }

      function showToast(message) {
        toastLayer.textContent = message;
        toastLayer.style.opacity = "1";
        toastLayer.style.transform = "translate(-50%, 0)";
        setTimeout(() => {
          toastLayer.style.opacity = "0";
          toastLayer.style.transform = "translate(-50%, 12px)";
        }, 1800);
      }

      function updateBadge() {
        const count = getCart().reduce((sum, item) => sum + (item.qty || 1), 0);
        document.querySelectorAll("[data-cart-count]").forEach((badge) => {
          if (badge) {
            badge.textContent = count;
            const shouldHide = count === 0;
            badge.classList.toggle("hidden", shouldHide);
          }
        });
      }

      function renderCart() {
        const cart = getCart();
        itemsContainer.innerHTML = "";

        if (!cart.length) {
          itemsContainer.innerHTML = `
            <div class="px-5 py-8 text-center text-sm text-slate-500">
              Tu carrito est√° vac√≠o. A√±ade servicios desde la p√°gina principal.
            </div>
          `;
          totalEl.textContent = formatCurrency(0);
          updateBadge();
          return;
        }

        cart.forEach((item, index) => {
          const row = document.createElement("div");
          row.className = "flex flex-col gap-3 px-5 py-4 text-sm sm:flex-row sm:items-center sm:justify-between";
          row.innerHTML = `
            <div>
              <p class="font-semibold text-slate-900">${item.name}</p>
              <p class="text-xs text-slate-500">${formatCurrency(item.price)} por servicio</p>
            </div>
            <div class="flex items-center gap-3">
              <div class="flex items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-2 py-1">
                <button
                  type="button"
                  class="w-7 h-7 inline-flex items-center justify-center rounded-lg text-slate-600 hover:bg-slate-200"
                  data-action="decrement"
                  data-index="${index}"
                  aria-label="Reducir cantidad"
                >
                  ‚àí
                </button>
                <span class="min-w-[2rem] text-center font-semibold text-slate-900">${item.qty || 1}</span>
                <button
                  type="button"
                  class="w-7 h-7 inline-flex items-center justify-center rounded-lg text-slate-600 hover:bg-slate-200"
                  data-action="increment"
                  data-index="${index}"
                  aria-label="Incrementar cantidad"
                >
                  +
                </button>
              </div>
              <button
                type="button"
                class="inline-flex items-center gap-2 rounded-xl border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-red-200 hover:text-red-500"
                data-action="remove"
                data-index="${index}"
              >
                Eliminar
              </button>
            </div>
          `;
          itemsContainer.appendChild(row);
        });

        const total = cart.reduce((sum, item) => sum + item.price * (item.qty || 1), 0);
        totalEl.textContent = formatCurrency(total);
        updateBadge();
      }

      itemsContainer.addEventListener("click", (event) => {
        const target = event.target.closest("button[data-action]");
        if (!target) return;

        const action = target.getAttribute("data-action");
        const index = Number(target.getAttribute("data-index"));
        const cart = getCart();
        const item = cart[index];
        if (!item) return;

        if (action === "increment") {
          item.qty = (item.qty || 1) + 1;
          setCart(cart);
          renderCart();
        }

        if (action === "decrement") {
          const nextQty = (item.qty || 1) - 1;
          if (nextQty <= 0) {
            cart.splice(index, 1);
          } else {
            item.qty = nextQty;
          }
          setCart(cart);
          renderCart();
        }

        if (action === "remove") {
          cart.splice(index, 1);
          setCart(cart);
          renderCart();
        }
      });

      clearBtn.addEventListener("click", () => {
        setCart([]);
        renderCart();
        showToast("Carrito vaciado");
      });

      document
        .getElementById("checkout-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const form = event.target;
          const submitBtn = form.querySelector('button[type="submit"]');
          const cart = getCart();

          if (!cart.length) {
            showToast("Tu carrito est√° vac√≠o");
            return;
          }

          const payload = {
            name: form.name.value.trim(),
            email: form.email.value.trim(),
            company: form.company.value.trim(),
            whatsappOptIn: whatsappCheckbox ? whatsappCheckbox.checked : false,
            whatsappNumber: whatsappInput ? whatsappInput.value.trim() : "",
            cart,
            total: cart.reduce((sum, item) => sum + item.price * (item.qty || 1), 0),
            createdAt: new Date().toISOString(),
            source: "Servicios - cart.html",
          };

          submitBtn.disabled = true;
          const originalText = submitBtn.textContent;
          submitBtn.textContent = "Enviando...";

          try {
            const res = await fetch(EMAIL_ENDPOINT, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
              },
              body: "payload=" + encodeURIComponent(JSON.stringify(payload)),
            });

            if (!res.ok) throw new Error("Solicitud fallida");

            showToast("Pedido enviado con √©xito. Te contactaremos pronto.");
            setCart([]);
            renderCart();
            form.reset();
            syncWhatsappField();
            setTimeout(() => {
              window.location.href = "index.html";
            }, 2000);
          } catch (error) {
            console.error("Error enviando pedido", error);
            showToast("Hubo un problema al enviar el pedido. Intenta nuevamente.");
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });

      renderCart();
      updateBadge();

      window.addEventListener("storage", (event) => {
        if (event.key === storageKey) {
          renderCart();
        }
      });

      window.addEventListener("load", () => {
        document.body.classList.remove("is-loading");
        document.body.classList.add("is-ready");
      });
    </script>
  </body>
</html>

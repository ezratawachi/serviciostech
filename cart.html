<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Carrito de servicios | E&I Systems</title>

    <meta
      name="description"
      content="Revisa los servicios seleccionados, ajusta cantidades y envía tu pedido para coordinar la implementación con E&I Systems."
    />
    <meta name="author" content="E&I Systems" />
    <meta name="theme-color" content="#030712" />

    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🛒</text></svg>"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap"
      rel="stylesheet"
    />

    <script>
      window.tailwind = window.tailwind || {};
      window.tailwind.config = {
        theme: {
          extend: {
            screens: { xs: "475px" },
            colors: {
              midnight: {
                50: "#f8fafc",
                100: "#e2e8f0",
                200: "#cbd5f5",
                300: "#94a3f8",
                400: "#818cf8",
                500: "#6366f1",
                600: "#4f46e5",
                700: "#312e81",
                800: "#1e1b4b",
                900: "#111032",
                950: "#05051a",
              },
              aura: {
                200: "#5eead4",
                300: "#2dd4bf",
                400: "#14b8a6",
                500: "#0d9488",
              },
            },
            boxShadow: {
              glass: "0 18px 40px rgba(15, 23, 42, 0.45)",
              glow: "0 30px 80px rgba(99, 102, 241, 0.45)",
            },
            fontFamily: {
              sans: [
                "Inter",
                "Space Grotesk",
                "ui-sans-serif",
                "system-ui",
                "-apple-system",
                "Segoe UI",
                "Roboto",
                "Helvetica",
                "Arial",
                "Apple Color Emoji",
                "Segoe UI Emoji",
              ],
              display: [
                "Space Grotesk",
                "Inter",
                "ui-sans-serif",
                "system-ui",
                "-apple-system",
              ],
            },
            borderRadius: {
              pill: "999px",
              xl: "1rem",
              "2xl": "1.5rem",
            },
          },
        },
      };
    </script>
    <script defer src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        color-scheme: dark;
        scroll-behavior: smooth;
      }
      body {
        background: radial-gradient(
            circle at top right,
            rgba(99, 102, 241, 0.16),
            transparent 46%
          ),
          radial-gradient(
            circle at 18% 22%,
            rgba(45, 212, 191, 0.12),
            transparent 40%
          ),
          #020617;
      }
      .skip-link {
        position: absolute;
        left: -999px;
        top: 1rem;
        padding: 0.6rem 1.2rem;
        background: linear-gradient(120deg, #4f46e5, #14b8a6);
        color: #f8fafc;
        border-radius: 999px;
        box-shadow: 0 18px 40px rgba(79, 70, 229, 0.45);
        transition: left 0.2s ease;
        z-index: 200;
        font-weight: 600;
        letter-spacing: 0.04em;
      }
      .skip-link:focus {
        left: 1rem;
      }
      .cart-action {
        position: relative;
        overflow: hidden;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        font-weight: 600;
        transition: transform 0.25s ease, box-shadow 0.25s ease,
          background 0.25s ease, border-color 0.25s ease, color 0.25s ease;
        will-change: transform, box-shadow, background, border-color, color;
      }
      .cart-action [data-icon] {
        display: none;
        align-items: center;
        justify-content: center;
      }
      .cart-action [data-icon] svg {
        width: 1rem;
        height: 1rem;
      }
      .cart-action[data-state="loading"] [data-icon="loading"],
      .cart-action[data-state="success"] [data-icon="success"] {
        display: inline-flex;
      }
      .cart-action[data-state="loading"] {
        cursor: wait;
      }
      .cart-action--primary[data-state="loading"] {
        background: linear-gradient(
          180deg,
          rgba(15, 23, 42, 0.92),
          rgba(22, 37, 57, 0.92)
        );
        color: #94a3b8;
        border-color: rgba(148, 163, 184, 0.4);
        box-shadow: none;
        animation: loadingPulse 1.2s ease-in-out infinite;
      }
      .cart-action--primary[data-state="success"] {
        background: linear-gradient(
          140deg,
          rgba(45, 212, 191, 0.95),
          rgba(20, 184, 166, 0.95)
        );
        color: #032c25;
        border-color: rgba(45, 212, 191, 0.9);
        box-shadow: 0 22px 44px rgba(45, 212, 191, 0.4);
        transform: translateY(-1px) scale(1.02);
        animation: successBounce 0.65s cubic-bezier(0.17, 0.89, 0.32, 1.28);
      }
      .cart-action--primary[data-state="success"]::before {
        content: "";
        position: absolute;
        inset: -15%;
        background: radial-gradient(
          circle at center,
          rgba(255, 255, 255, 0.6),
          transparent 68%
        );
        opacity: 0;
        border-radius: inherit;
        animation: successGlow 0.8s ease-out forwards;
        pointer-events: none;
      }
      .cart-action--ghost[data-state="loading"] {
        color: #cbd5f5;
      }
      .cart-action--ghost[data-state="success"] {
        color: #5eead4;
      }
      .cart-action[data-state="error"] {
        background: linear-gradient(
          180deg,
          rgba(127, 29, 29, 0.12),
          rgba(76, 5, 25, 0.12)
        );
        border-color: rgba(248, 113, 113, 0.35);
        color: #fecdd3;
        box-shadow: 0 20px 42px rgba(248, 113, 113, 0.18);
      }
      @keyframes loadingPulse {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 rgba(148, 163, 184, 0.22);
        }
        50% {
          transform: scale(0.99);
          box-shadow: 0 0 0 8px rgba(148, 163, 184, 0.18);
        }
      }
      @keyframes successBounce {
        0% {
          transform: translateY(0) scale(0.96);
        }
        50% {
          transform: translateY(-3px) scale(1.06);
        }
        100% {
          transform: translateY(-1px) scale(1);
        }
      }
      @keyframes successGlow {
        0% {
          opacity: 0.98;
          transform: scale(0.8);
        }
        100% {
          opacity: 0;
          transform: scale(1.65);
        }
      }
      @media (prefers-reduced-motion: reduce) {
        .cart-action,
        .cart-action::before {
          animation: none !important;
          transition-duration: 0.01ms !important;
        }
      }
      body.is-loading {
        opacity: 0;
      }
      body.is-ready {
        opacity: 1;
        transition: opacity 0.35s ease;
      }
    </style>
  </head>
  <body class="bg-[#020617] text-slate-100 font-sans antialiased is-loading">
    <a href="#contenido-principal" class="skip-link">Saltar al contenido</a>

    <header
      class="sticky top-0 z-40 border-b border-white/10 bg-[#03091d]/85 backdrop-blur-xl"
    >
      <nav
        class="mx-auto w-full max-w-7xl px-4 sm:px-6 lg:px-8"
        aria-label="Principal"
      >
        <div class="flex h-16 items-center justify-between gap-4">
          <a
            href="index.html"
            class="flex items-center gap-2 text-sm font-semibold text-slate-200"
          >
            <span
              class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/10 text-sm font-display font-semibold text-white shadow-glow"
            >
              E&amp;I
            </span>
            <span class="text-base font-display tracking-tight"
              >E&I Systems</span
            >
          </a>
          <div class="hidden items-center gap-2 text-sm font-medium md:flex">
            <a
              href="index.html#galeria"
              class="rounded-lg px-3 py-2 text-slate-300 transition hover:bg-white/10 hover:text-white"
              >Servicios</a
            >
            <a
              href="index.html#detalles"
              class="rounded-lg px-3 py-2 text-slate-300 transition hover:bg-white/10 hover:text-white"
              >Casos</a
            >
            <a
              href="index.html#contacto"
              class="rounded-lg px-3 py-2 text-slate-300 transition hover:bg-white/10 hover:text-white"
              >Contacto</a
            >
            <a
              href="cart.html"
              aria-current="page"
              class="relative inline-flex items-center gap-2 rounded-pill border border-white/10 bg-white/10 px-3 py-2 text-white shadow-[0_1px_0_rgba(255,255,255,0.1)]"
            >
              Carrito
              <span
                data-cart-count
                class="inline-flex h-5 min-w-[1.25rem] items-center justify-center rounded-full bg-midnight-500 px-1 text-[10px] font-extrabold leading-none text-white"
                aria-live="polite"
              ></span>
            </a>
          </div>
          <button
            type="button"
            id="mobile-menu-button"
            class="inline-flex h-11 w-11 items-center justify-center rounded-xl border border-white/10 bg-white/5 text-white/80 transition hover:bg-white/10 md:hidden"
            aria-controls="mobile-menu"
            aria-expanded="false"
          >
            <span class="sr-only">Abrir menú</span>
            <svg
              data-menu-icon="open"
              class="h-6 w-6"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            <svg
              data-menu-icon="close"
              class="hidden h-6 w-6"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M6 6l12 12M6 18L18 6" />
            </svg>
          </button>
        </div>
      </nav>
      <div
        id="mobile-menu"
        class="hidden border-t border-white/10 bg-[#020a1a]/95 md:hidden"
      >
        <div
          class="mx-auto flex max-w-7xl flex-col gap-2 px-4 py-4 text-sm font-semibold text-slate-200"
        >
          <a
            data-mobile-link
            href="index.html#galeria"
            class="rounded-lg px-3 py-2 hover:bg-white/10"
            >Servicios</a
          >
          <a
            data-mobile-link
            href="index.html#detalles"
            class="rounded-lg px-3 py-2 hover:bg-white/10"
            >Casos</a
          >
          <a
            data-mobile-link
            href="index.html#contacto"
            class="rounded-lg px-3 py-2 hover:bg-white/10"
            >Contacto</a
          >
          <a
            data-mobile-link
            href="cart.html"
            class="flex items-center justify-between rounded-lg px-3 py-2 hover:bg-white/10"
          >
            Carrito
            <span
              data-cart-count
              class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-midnight-500 text-[10px] font-extrabold leading-none text-white"
            ></span>
          </a>
        </div>
      </div>
    </header>

    <main id="contenido-principal" class="py-16 sm:py-20" tabindex="-1">
      <section class="relative">
        <div
          class="absolute inset-x-0 top-0 h-px bg-gradient-to-r from-transparent via-white/10 to-transparent"
        ></div>
        <div class="mx-auto w-full max-w-6xl px-4 sm:px-6 lg:px-8">
          <header class="text-center" data-animate="fade-up">
            <p
              class="text-xs font-semibold uppercase tracking-[0.32em] text-white/60"
            >
              Resumen
            </p>
            <h1
              class="mt-3 text-3xl font-display font-semibold text-white sm:text-4xl"
            >
              Tu carrito de servicios
            </h1>
            <p
              class="mx-auto mt-3 max-w-2xl text-sm sm:text-base text-slate-300"
            >
              Ajusta cantidades y envía tus datos. Te responderé en menos de 24
              horas hábiles con la agenda y próximos pasos.
            </p>
          </header>

          <div class="mt-10 grid gap-6 lg:grid-cols-[1.25fr_0.85fr]">
            <section
              class="space-y-4"
              data-animate="fade-up"
              data-animate-delay="0.05s"
            >
              <div
                class="overflow-hidden rounded-[1.8rem] border border-white/10 bg-white/5 shadow-glass backdrop-blur-xl"
              >
                <div
                  class="flex items-center justify-between border-b border-white/10 px-6 py-5"
                >
                  <h2 class="text-base font-semibold text-white">
                    Servicios seleccionados
                  </h2>
                  <button
                    type="button"
                    id="clear-cart"
                    data-state="idle"
                    data-label-idle="Vaciar carrito"
                    data-label-loading="Vaciando..."
                    data-label-success="Carrito vacío"
                    data-label-error="Sin servicios"
                    class="cart-action cart-action--ghost text-xs font-semibold uppercase tracking-[0.28em] text-white/60 transition hover:text-white"
                  >
                    <span data-icon="loading" aria-hidden="true">
                      <svg
                        class="animate-spin text-current"
                        viewBox="0 0 24 24"
                        fill="none"
                      >
                        <circle
                          class="opacity-25"
                          cx="12"
                          cy="12"
                          r="10"
                          stroke="currentColor"
                          stroke-width="3"
                        ></circle>
                        <path
                          class="opacity-75"
                          d="M4 12a8 8 0 0 1 8-8"
                          stroke="currentColor"
                          stroke-width="3"
                          stroke-linecap="round"
                        ></path>
                      </svg>
                    </span>
                    <span data-icon="success" aria-hidden="true">
                      <svg viewBox="0 0 20 20" fill="currentColor">
                        <path
                          fill-rule="evenodd"
                          d="M16.707 5.293a1 1 0 0 1 0 1.414l-7.128 7.128a1 1 0 0 1-1.414 0L3.293 9.964a1 1 0 1 1 1.414-1.414l3.043 3.043 6.421-6.421a1 1 0 0 1 1.414 0z"
                          clip-rule="evenodd"
                        ></path>
                      </svg>
                    </span>
                    <span data-label aria-live="polite">Vaciar carrito</span>
                  </button>
                </div>
                <div id="cart-items" class="divide-y divide-white/5">
                  <!-- Items renderizados por JS -->
                </div>
                <div class="flex items-center justify-between px-6 py-5">
                  <span class="text-sm font-semibold text-slate-300"
                    >Total estimado</span
                  >
                  <span id="cart-total" class="text-xl font-semibold text-white"
                    >USD $0</span
                  >
                </div>
              </div>

              <a
                href="index.html#galeria"
                class="inline-flex w-full items-center justify-center gap-2 rounded-pill border border-white/10 bg-white/10 px-5 py-3 text-sm font-semibold text-white transition hover:bg-white/20"
              >
                ← Seguir explorando servicios
              </a>
            </section>

            <section
              class="rounded-[1.8rem] border border-white/10 bg-white/5 p-8 shadow-glass backdrop-blur-xl"
              data-animate="fade-up"
              data-animate-delay="0.1s"
            >
              <h2 class="text-base font-semibold text-white">
                Envía tu pedido
              </h2>
              <p class="mt-1 text-sm text-slate-300">
                Completa tus datos. Recibirás confirmación y propuesta de
                agenda.
              </p>
              <form id="checkout-form" class="mt-6 space-y-4 text-left">
                <div>
                  <label for="name" class="text-sm font-medium text-white/80"
                    >Nombre completo</label
                  >
                  <input
                    type="text"
                    id="name"
                    name="name"
                    required
                    autocomplete="name"
                    class="mt-1 w-full rounded-xl border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder:text-slate-400 focus-visible:border-midnight-400 focus-visible:outline-none"
                  />
                </div>
                <div>
                  <label for="email" class="text-sm font-medium text-white/80"
                    >Correo electrónico</label
                  >
                  <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    autocomplete="email"
                    class="mt-1 w-full rounded-xl border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder:text-slate-400 focus-visible:border-midnight-400 focus-visible:outline-none"
                  />
                </div>
                <div>
                  <label
                    class="flex items-start gap-3 rounded-xl border border-white/15 bg-white/5 px-3 py-3 text-sm font-medium text-white/80"
                    for="whatsapp-opt-in"
                  >
                    <input
                      id="whatsapp-opt-in"
                      name="whatsappOptIn"
                      type="checkbox"
                      class="mt-1 h-4 w-4 rounded border-white/30 bg-white/10 text-midnight-400 transition focus:ring-midnight-300"
                    />
                    <span>
                      ¿Quieres coordinación por WhatsApp?
                      <span
                        class="mt-1 block text-xs font-normal text-slate-400"
                      >
                        Si activas esta opción, indícanos tu número y recibirás
                        seguimiento directo.
                      </span>
                    </span>
                  </label>
                </div>
                <div id="whatsapp-field" class="hidden">
                  <label
                    for="whatsapp-number"
                    class="text-sm font-medium text-white/80"
                    >Número de WhatsApp</label
                  >
                  <input
                    type="tel"
                    id="whatsapp-number"
                    name="whatsappNumber"
                    autocomplete="tel"
                    inputmode="tel"
                    placeholder="Ej: +507 6000-0000"
                    class="mt-1 w-full rounded-xl border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder:text-slate-400 focus-visible:border-midnight-400 focus-visible:outline-none"
                  />
                </div>
                <div>
                  <label for="company" class="text-sm font-medium text-white/80"
                    >Empresa (opcional)</label
                  >
                  <input
                    type="text"
                    id="company"
                    name="company"
                    autocomplete="organization"
                    class="mt-1 w-full rounded-xl border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder:text-slate-400 focus-visible:border-midnight-400 focus-visible:outline-none"
                  />
                </div>
                <button
                  type="submit"
                  data-state="idle"
                  data-label-idle="Enviar pedido"
                  data-label-loading="Enviando..."
                  data-label-success="Pedido enviado"
                  data-label-error="No se pudo enviar"
                  data-label-empty="Añade servicios"
                  class="cart-action cart-action--primary inline-flex w-full items-center justify-center gap-2 rounded-pill bg-gradient-to-r from-midnight-500 to-aura-400 px-5 py-2.5 text-sm font-semibold text-white shadow-glow transition hover:from-midnight-400 hover:to-aura-300 disabled:cursor-not-allowed disabled:opacity-50"
                >
                  <span data-icon="loading" aria-hidden="true">
                    <svg
                      class="animate-spin text-current"
                      viewBox="0 0 24 24"
                      fill="none"
                    >
                      <circle
                        class="opacity-25"
                        cx="12"
                        cy="12"
                        r="10"
                        stroke="currentColor"
                        stroke-width="3"
                      ></circle>
                      <path
                        class="opacity-75"
                        d="M4 12a8 8 0 0 1 8-8"
                        stroke="currentColor"
                        stroke-width="3"
                        stroke-linecap="round"
                      ></path>
                    </svg>
                  </span>
                  <span data-icon="success" aria-hidden="true">
                    <svg viewBox="0 0 20 20" fill="currentColor">
                      <path
                        fill-rule="evenodd"
                        d="M16.707 5.293a1 1 0 0 1 0 1.414l-7.128 7.128a1 1 0 0 1-1.414 0L3.293 9.964a1 1 0 1 1 1.414-1.414l3.043 3.043 6.421-6.421a1 1 0 0 1 1.414 0z"
                        clip-rule="evenodd"
                      ></path>
                    </svg>
                  </span>
                  <span data-label aria-live="polite">Enviar pedido</span>
                </button>
              </form>
            </section>
          </div>
        </div>
      </section>
    </main>

    <footer class="border-t border-white/10 bg-[#03091d]/80">
      <div
        class="mx-auto w-full max-w-7xl px-4 py-6 text-center text-xs sm:text-sm text-slate-400"
      >
        © 2025 E&I Systems · Automatización y analítica para empresas en Panamá.
      </div>
    </footer>

    <script>
      const storageKey = "ezraServicesCart";
      const EMAIL_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbxsveSHW1PjbIKBQv4apyYQhaWWe-JnL6I1f2Kf4yOHLWFlTgzLl67Vgp8qZAOhLQHb/exec";

      const itemsContainer = document.getElementById("cart-items");
      const totalEl = document.getElementById("cart-total");
      const clearBtn = document.getElementById("clear-cart");
      const mobileMenuButton = document.getElementById("mobile-menu-button");
      const mobileMenu = document.getElementById("mobile-menu");
      const whatsappCheckbox = document.getElementById("whatsapp-opt-in");
      const whatsappFieldWrapper = document.getElementById("whatsapp-field");
      const whatsappInput = document.getElementById("whatsapp-number");
      const buttonResetTimers = new WeakMap();

      const updateActionButtonLabel = (button, state, overrideLabel) => {
        if (!button) return;
        const labelEl = button.querySelector("[data-label]");
        if (!labelEl) return;
        if (typeof overrideLabel === "string" && overrideLabel.length) {
          labelEl.textContent = overrideLabel;
          return;
        }
        const normalized = state ? state.toLowerCase() : "idle";
        const key = `label${normalized
          .charAt(0)
          .toUpperCase()}${normalized.slice(1)}`;
        const fallback = button.dataset.labelIdle || labelEl.textContent;
        labelEl.textContent = button.dataset[key] || fallback;
      };

      const setButtonState = (button, state, overrideLabel) => {
        if (!button) return;
        button.dataset.state = state;
        updateActionButtonLabel(button, state, overrideLabel);
      };

      const cancelButtonIdle = (button) => {
        if (!button) return;
        const existing = buttonResetTimers.get(button);
        if (existing) {
          clearTimeout(existing);
          buttonResetTimers.delete(button);
        }
      };

      const scheduleButtonIdle = (button, delay = 0, callback) => {
        if (!button) return;
        cancelButtonIdle(button);
        const normalizedDelay = Math.max(0, delay);
        if (!normalizedDelay) {
          setButtonState(button, "idle");
          if (typeof callback === "function") {
            callback();
          }
          return;
        }
        const timer = window.setTimeout(() => {
          setButtonState(button, "idle");
          if (typeof callback === "function") {
            callback();
          }
          buttonResetTimers.delete(button);
        }, normalizedDelay);
        buttonResetTimers.set(button, timer);
      };

      const syncWhatsappField = () => {
        if (!whatsappCheckbox || !whatsappFieldWrapper || !whatsappInput)
          return;
        const wantsWhatsapp = whatsappCheckbox.checked;
        whatsappFieldWrapper.classList.toggle("hidden", !wantsWhatsapp);
        whatsappInput.required = wantsWhatsapp;
        if (!wantsWhatsapp) {
          whatsappInput.value = "";
        }
      };

      if (whatsappCheckbox) {
        whatsappCheckbox.addEventListener("change", syncWhatsappField);
        syncWhatsappField();
      }

      if (mobileMenuButton && mobileMenu) {
        const mobileMenuIcons = {
          open: mobileMenuButton.querySelector('[data-menu-icon="open"]'),
          close: mobileMenuButton.querySelector('[data-menu-icon="close"]'),
        };

        const setMenuState = (open) => {
          mobileMenuButton.setAttribute("aria-expanded", String(open));
          if (open) {
            mobileMenu.classList.remove("hidden");
            if (mobileMenuIcons.open) {
              mobileMenuIcons.open.classList.add("hidden");
            }
            if (mobileMenuIcons.close) {
              mobileMenuIcons.close.classList.remove("hidden");
            }
          } else {
            mobileMenu.classList.add("hidden");
            if (mobileMenuIcons.open) {
              mobileMenuIcons.open.classList.remove("hidden");
            }
            if (mobileMenuIcons.close) {
              mobileMenuIcons.close.classList.add("hidden");
            }
          }
        };

        mobileMenuButton.addEventListener("click", () => {
          const isOpen =
            mobileMenuButton.getAttribute("aria-expanded") === "true";
          setMenuState(!isOpen);
        });

        document.querySelectorAll("[data-mobile-link]").forEach((link) => {
          link.addEventListener("click", () => setMenuState(false));
        });

        const desktopBreakpoint = window.matchMedia("(min-width: 768px)");
        const handleBreakpointChange = (event) => {
          if (event.matches) {
            setMenuState(false);
          }
        };

        if (typeof desktopBreakpoint.addEventListener === "function") {
          desktopBreakpoint.addEventListener("change", handleBreakpointChange);
        } else if (typeof desktopBreakpoint.addListener === "function") {
          desktopBreakpoint.addListener(handleBreakpointChange);
        }

        setMenuState(false);
      }

      const formatCurrency = (value) =>
        new Intl.NumberFormat("es-PA", {
          style: "currency",
          currency: "USD",
          minimumFractionDigits: 0,
        }).format(value);

      function getCart() {
        try {
          const raw = localStorage.getItem(storageKey);
          return raw ? JSON.parse(raw) : [];
        } catch (error) {
          console.error("No se pudo leer el carrito", error);
          return [];
        }
      }

      function setCart(items) {
        try {
          localStorage.setItem(storageKey, JSON.stringify(items));
        } catch (error) {
          console.error("No se pudo guardar el carrito", error);
        }
      }

      function updateBadge() {
        const count = getCart().reduce((sum, item) => sum + (item.qty || 1), 0);
        document.querySelectorAll("[data-cart-count]").forEach((badge) => {
          if (badge) {
            badge.textContent = count;
            badge.classList.toggle("hidden", count === 0);
          }
        });
      }

      function renderCart() {
        const cart = getCart();
        itemsContainer.innerHTML = "";

        if (!cart.length) {
          itemsContainer.innerHTML = `
            <div class="px-6 py-10 text-center text-sm text-slate-400">
              Tu carrito está vacío. Añade servicios desde la página principal.
            </div>
          `;
          totalEl.textContent = formatCurrency(0);
          updateBadge();
          return;
        }

        cart.forEach((item, index) => {
          const row = document.createElement("div");
          row.className =
            "flex flex-col gap-4 px-6 py-4 text-sm text-slate-200 sm:flex-row sm:items-center sm:justify-between";
          row.innerHTML = `
            <div>
              <p class="font-semibold text-white">${item.name}</p>
              <p class="text-xs text-slate-400">${formatCurrency(
                item.price
              )} por servicio</p>
            </div>
            <div class="flex items-center gap-3">
              <button
                type="button"
                class="inline-flex items-center gap-2 rounded-pill border border-white/10 px-3 py-1.5 text-xs font-semibold text-white/70 transition hover:border-rose-300/60 hover:text-rose-200"
                data-action="remove"
                data-index="${index}"
              >
                Eliminar
              </button>
            </div>
          `;
          itemsContainer.appendChild(row);
        });

        const total = cart.reduce(
          (sum, item) => sum + item.price * (item.qty || 1),
          0
        );
        totalEl.textContent = formatCurrency(total);
        updateBadge();
      }

      itemsContainer.addEventListener("click", (event) => {
        const target = event.target.closest("button[data-action]");
        if (!target) return;

        const action = target.getAttribute("data-action");
        const index = Number(target.getAttribute("data-index"));
        const cart = getCart();
        const item = cart[index];
        if (!item) return;

        if (action === "increment") {
          item.qty = (item.qty || 1) + 1;
          setCart(cart);
          renderCart();
        }

        if (action === "decrement") {
          const nextQty = (item.qty || 1) - 1;
          if (nextQty <= 0) {
            cart.splice(index, 1);
          } else {
            item.qty = nextQty;
          }
          setCart(cart);
          renderCart();
        }

        if (action === "remove") {
          cart.splice(index, 1);
          setCart(cart);
          renderCart();
        }
      });

      if (clearBtn) {
        setButtonState(clearBtn, clearBtn.dataset.state || "idle");
        clearBtn.addEventListener("click", () => {
          if (clearBtn.dataset.state === "loading") return;
          const currentCart = getCart();
          cancelButtonIdle(clearBtn);
          setButtonState(clearBtn, "loading");
          const delay = currentCart.length ? 420 : 260;
          window.setTimeout(() => {
            if (currentCart.length) {
              setCart([]);
              renderCart();
              setButtonState(clearBtn, "success");
            } else {
              setButtonState(clearBtn, "error");
              scheduleButtonIdle(clearBtn, 1600);
              return;
            }
            scheduleButtonIdle(clearBtn, 1800);
          }, delay);
        });
      }

      const checkoutForm = document.getElementById("checkout-form");
      const submitBtn = checkoutForm
        ? checkoutForm.querySelector('button[type="submit"]')
        : null;

      if (submitBtn) {
        setButtonState(submitBtn, submitBtn.dataset.state || "idle");
      }

      if (checkoutForm) {
        checkoutForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const form = event.target;
          const cart = getCart();

          if (!submitBtn) {
            return;
          }

          if (!cart.length) {
            setButtonState(
              submitBtn,
              "error",
              submitBtn.dataset.labelEmpty || "Añade servicios"
            );
            scheduleButtonIdle(submitBtn, 2000, () => {
              submitBtn.disabled = false;
            });
            return;
          }

          if (submitBtn.dataset.state === "loading") {
            return;
          }

          cancelButtonIdle(submitBtn);
          setButtonState(submitBtn, "loading");
          submitBtn.disabled = true;

          const payload = {
            name: form.name.value.trim(),
            email: form.email.value.trim(),
            company: form.company.value.trim(),
            whatsappOptIn: whatsappCheckbox ? whatsappCheckbox.checked : false,
            whatsappNumber: whatsappInput ? whatsappInput.value.trim() : "",
            cart,
            total: cart.reduce(
              (sum, item) => sum + item.price * (item.qty || 1),
              0
            ),
            createdAt: new Date().toISOString(),
            source: "Servicios - cart.html",
          };

          try {
            const res = await fetch(EMAIL_ENDPOINT, {
              method: "POST",
              headers: {
                "Content-Type":
                  "application/x-www-form-urlencoded;charset=UTF-8",
              },
              body: "payload=" + encodeURIComponent(JSON.stringify(payload)),
            });

            if (!res.ok) throw new Error("Solicitud fallida");

            setCart([]);
            renderCart();
            form.reset();
            syncWhatsappField();
            setButtonState(submitBtn, "success");
            scheduleButtonIdle(submitBtn, 2400, () => {
              submitBtn.disabled = false;
            });
            window.setTimeout(() => {
              window.location.href = "index.html";
            }, 2200);
          } catch (error) {
            console.error("Error enviando pedido", error);
            setButtonState(submitBtn, "error");
            scheduleButtonIdle(submitBtn, 2400, () => {
              submitBtn.disabled = false;
            });
          }
        });
      }

      renderCart();
      updateBadge();

      window.addEventListener("storage", (event) => {
        if (event.key === storageKey) {
          renderCart();
        }
      });

      window.addEventListener("load", () => {
        document.body.classList.remove("is-loading");
        document.body.classList.add("is-ready");
      });
    </script>
  </body>
</html>
